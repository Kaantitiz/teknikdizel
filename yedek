import streamlit as st
import pandas as pd
import folium
from streamlit_folium import folium_static
import googlemaps
from datetime import datetime
import os
from math import cos, sin, radians

# YeÅŸil/KÄ±rmÄ±zÄ± yuvarlak ikonlar iÃ§in ortak stil
icon_style = """
    <div style="
        font-size: 14pt; 
        color: white; 
        font-weight: bold; 
        background-color: {color}; 
        border-radius: 50%; 
        width: 30px; 
        height: 30px; 
        display: flex; 
        align-items: center; 
        justify-content: center;
        border: 2px solid white;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    ">{sira}</div>
"""

# Google Maps API anahtarÄ±nÄ±zÄ± buraya ekleyin
gmaps = googlemaps.Client(key="AIzaSyAwIzNu_goWzvuRfLWzWEZJZ0p8hcxujbs")

# Sayfa baÅŸlÄ±ÄŸÄ± ve ikonu
st.set_page_config(page_title="Harita OluÅŸturma", page_icon="ğŸŒ", layout="wide")
st.markdown("<h1 style='text-align: center;'>Harita GÃ¶rselleÅŸtirme</h1>", unsafe_allow_html=True)

# API istek sayacÄ±
api_istek_sayisi = 0

# KlasÃ¶r ayarlarÄ±
UPLOAD_FOLDER = "uploaded_files"
os.makedirs(UPLOAD_FOLDER, exist_ok=True)

# KullanÄ±cÄ± seÃ§imi: Yeni dosya yÃ¼kle veya mevcut bir dosyayÄ± seÃ§
option = st.radio(
    "SeÃ§im YapÄ±n:",
    ("KayÄ±tlÄ± Bir DosyayÄ± SeÃ§",)
)

uploaded_file = None
selected_file = None

def offset_coordinates(lat, lng, index, total):
    """
    AynÄ± konumda olan noktalarÄ± hafifÃ§e birbirinden ayÄ±rmak iÃ§in kÃ¼Ã§Ã¼k ofset uygular.
    """
    if total > 1:  # EÄŸer aynÄ± noktada birden fazla varsa
        angle = (360 / total) * index  # Her noktaya farklÄ± aÃ§Ä±
        radius = 0.0003  # KaydÄ±rma mesafesi (~30m)
        lat += radius * cos(radians(angle))
        lng += radius * sin(radians(angle))
    return lat, lng

if option == "KayÄ±tlÄ± Bir DosyayÄ± SeÃ§":
    # KayÄ±tlÄ± dosyalarÄ± listele (sadece belirli tarih formatÄ±na sahip dosyalar)
    files = [f for f in os.listdir(UPLOAD_FOLDER) if f.endswith((".xlsx", ".xls"))]
    
    # Tarih formatÄ±na uygun dosyalarÄ± filtrele
    def is_valid_date_format(filename):
        try:
            # Dosya adÄ±ndan tarih kÄ±smÄ±nÄ± al (Ã¶rneÄŸin: "2023-10-05.xlsx" -> "2023-10-05")
            date_part = filename.split(".")[0]
            datetime.strptime(date_part, "%Y-%m-%d")  # Tarih formatÄ±nÄ± kontrol et
            return True
        except ValueError:
            return False

    # Sadece tarih formatÄ±na uygun dosyalarÄ± listele
    valid_files = [f for f in files if is_valid_date_format(f)]
    
    if valid_files:
        # "LÃ¼tfen bir dosya seÃ§in" seÃ§eneÄŸi ekle
        files_with_prompt = ["LÃ¼tfen bir dosya seÃ§in"] + valid_files
        selected_file = st.selectbox("Bir dosya seÃ§in:", files_with_prompt)
        
        # EÄŸer kullanÄ±cÄ± "LÃ¼tfen bir dosya seÃ§in" dÄ±ÅŸÄ±nda bir dosya seÃ§erse
        if selected_file != "LÃ¼tfen bir dosya seÃ§in":
            st.info(f"SeÃ§ilen dosya iÅŸleniyor: {selected_file}")
            file_path = os.path.join(UPLOAD_FOLDER, selected_file)
            
            # Excel dosyasÄ±nÄ± oku
            df = pd.read_excel(file_path)

            # Sadece "Kontak AÃ§Ä±ldÄ±" ve "Kontak KapalÄ±" verilerini filtrele
            df = df[df['Ä°leti Tipi'].isin(["Kontak AÃ§Ä±ldÄ±", "Kontak KapalÄ±"])]

            # Plaka ve SÃ¼rÃ¼cÃ¼ bilgilerini birleÅŸtir
            if 'Plaka' in df.columns and 'SÃ¼rÃ¼cÃ¼' in df.columns:
                df['Plaka_SÃ¼rÃ¼cÃ¼'] = df['Plaka'] + " - " + df['SÃ¼rÃ¼cÃ¼']
                
                # Plaka seÃ§imi iÃ§in baÅŸlangÄ±Ã§ deÄŸeri
                plaka_sÃ¼rÃ¼cÃ¼_seÃ§imi = st.selectbox("Bir Plaka ve SÃ¼rÃ¼cÃ¼ SeÃ§in", ["LÃ¼tfen araÃ§ seÃ§iniz"] + list(df['Plaka_SÃ¼rÃ¼cÃ¼'].unique()))

                # EÄŸer kullanÄ±cÄ± "LÃ¼tfen araÃ§ seÃ§iniz" dÄ±ÅŸÄ±nda bir plaka seÃ§erse
                if plaka_sÃ¼rÃ¼cÃ¼_seÃ§imi != "LÃ¼tfen araÃ§ seÃ§iniz":
                    # SeÃ§ilen plaka ve sÃ¼rÃ¼cÃ¼ye gÃ¶re filtrele
                    filtered_df = df[df['Plaka_SÃ¼rÃ¼cÃ¼'] == plaka_sÃ¼rÃ¼cÃ¼_seÃ§imi]

                    # Zaman sÃ¼tununa gÃ¶re sÄ±rala
                    filtered_df = filtered_df.sort_values(by='Zaman')

                    # SÄ±ra numarasÄ± ekle
                    filtered_df['SÄ±ra'] = range(1, len(filtered_df) + 1)

                    # Nokta seÃ§imi iÃ§in dropdown buton (aralÄ±k seÃ§imi)
                    sÄ±ra_numaralarÄ± = filtered_df['SÄ±ra'].unique()
                    nokta_aralÄ±klarÄ± = [f"{sÄ±ra_numaralarÄ±[i]}-{sÄ±ra_numaralarÄ±[i+1]}" for i in range(len(sÄ±ra_numaralarÄ±)-1)]
                    
                    # "00.00 - 06.00 Hareketleri" seÃ§eneÄŸini ekle
                    nokta_seÃ§imi = st.selectbox("Nokta SeÃ§", ["TÃ¼mÃ¼nÃ¼ GÃ¶ster", "00.00 - 06.00 Hareketleri"] + nokta_aralÄ±klarÄ±)

                    # EÄŸer kullanÄ±cÄ± "00.00 - 06.00 Hareketleri"ni seÃ§tiyse, bu saat aralÄ±ÄŸÄ±nda filtrele
                    if nokta_seÃ§imi == "00.00 - 06.00 Hareketleri":
                        filtered_df['Zaman'] = pd.to_datetime(filtered_df['Zaman'], errors='coerce')
                        filtered_df = filtered_df.dropna(subset=['Zaman'])

                        # 00:00 - 06:00 saat aralÄ±ÄŸÄ±nda filtreleme
                        filtered_df = filtered_df[(filtered_df['Zaman'].dt.hour >= 0) & (filtered_df['Zaman'].dt.hour < 6)]

                        if filtered_df.empty:
                            st.error("Hareket AlgÄ±lanmadÄ±!")
                        else:
                            st.success("00.00 - 06.00 saatleri arasÄ±nda hareket algÄ±landÄ±!")

                    # Adresleri koordinatlara dÃ¶nÃ¼ÅŸtÃ¼r ve rotalarÄ± hesapla
                    if 'Adres' in df.columns:
                        coordinates = []  # GÃ¼zergah iÃ§in koordinat listesi
                        routes = []  # RotalarÄ± saklamak iÃ§in liste
                        coords_count = {}  # AynÄ± konumda kaÃ§ tane nokta olduÄŸunu takip etmek iÃ§in

                        for index, row in filtered_df.iterrows():
                            geocode_result = gmaps.geocode(row['Adres'])
                            api_istek_sayisi += 1  # Geocoding API isteÄŸi sayÄ±sÄ±nÄ± artÄ±r
                            if geocode_result:
                                location = geocode_result[0]['geometry']['location']
                                lat, lng = location['lat'], location['lng']

                                key = (round(lat, 5), round(lng, 5))  # YakÄ±n konumlarÄ± grupla
                                if key not in coords_count:
                                    coords_count[key] = 0
                                coords_count[key] += 1

                                # Ofset uygula
                                lat, lng = offset_coordinates(lat, lng, coords_count[key], len(filtered_df[filtered_df['Adres'] == row['Adres']]))

                                coordinates.append((lat, lng))
                            else:
                                st.warning(f"Adres bulunamadÄ±: {row['Adres']}")

                        # GidiÅŸ ve dÃ¶nÃ¼ÅŸ rotalarÄ±nÄ± hesapla
                        if len(coordinates) >= 2:
                            mid_point = len(coordinates) // 2  # Orta nokta
                            gidiÅŸ_coordinates = coordinates[:mid_point + 1]  # GidiÅŸ rotasÄ±
                            dÃ¶nÃ¼ÅŸ_coordinates = coordinates[mid_point:]  # DÃ¶nÃ¼ÅŸ rotasÄ±

                            # GidiÅŸ rotasÄ±nÄ± hesapla ve sakla
                            for i in range(len(gidiÅŸ_coordinates) - 1):
                                start = gidiÅŸ_coordinates[i]
                                end = gidiÅŸ_coordinates[i + 1]
                                directions_result = gmaps.directions(
                                    origin=start,
                                    destination=end,
                                    mode="driving",
                                    departure_time=datetime.now()
                                )
                                api_istek_sayisi += 1  # Directions API isteÄŸi sayÄ±sÄ±nÄ± artÄ±r
                                route = directions_result[0]['overview_polyline']['points']
                                decoded_route = googlemaps.convert.decode_polyline(route)
                                routes.append(decoded_route)

                            # DÃ¶nÃ¼ÅŸ rotasÄ±nÄ± hesapla ve sakla
                            for i in range(len(dÃ¶nÃ¼ÅŸ_coordinates) - 1):
                                start = dÃ¶nÃ¼ÅŸ_coordinates[i]
                                end = dÃ¶nÃ¼ÅŸ_coordinates[i + 1]
                                directions_result = gmaps.directions(
                                    origin=start,
                                    destination=end,
                                    mode="driving",
                                    departure_time=datetime.now()
                                )
                                api_istek_sayisi += 1  # Directions API isteÄŸi sayÄ±sÄ±nÄ± artÄ±r
                                route = directions_result[0]['overview_polyline']['points']
                                decoded_route = googlemaps.convert.decode_polyline(route)
                                routes.append(decoded_route)

                        # EÄŸer en az bir koordinat varsa, haritayÄ± ilk noktaya odakla
                        if coordinates:
                            map_center = coordinates[0]  # Ä°lk nokta baÅŸlangÄ±Ã§ konumu olsun
                        else:
                            st.error("Harita oluÅŸturulamadÄ±! GeÃ§erli koordinat bulunamadÄ±.")
                            map_center = [0, 0]  # Ä°stanbul'un merkez koordinatlarÄ±nÄ± kullan

                        m = folium.Map(location=map_center, zoom_start=14)

                        # HaritanÄ±n sol tarafÄ±nda butonlar oluÅŸtur
                        with st.sidebar:
                            st.header("SÄ±ra NumaralarÄ±")
                            for sira in filtered_df['SÄ±ra'].unique():
                                if st.button(f"SÄ±ra {sira}"):
                                    # Butona tÄ±klandÄ±ÄŸÄ±nda ilgili noktanÄ±n rengini siyaha dÃ¶n
                                    for index, row in filtered_df.iterrows():
                                        if row['SÄ±ra'] == sira:
                                            geocode_result = gmaps.geocode(row['Adres'])
                                            if geocode_result:
                                                location = geocode_result[0]['geometry']['location']
                                                lat, lng = location['lat'], location['lng']
                                                key = (round(lat, 5), round(lng, 5))
                                                if key in coords_count:
                                                    lat, lng = offset_coordinates(lat, lng, coords_count[key], len(filtered_df[filtered_df['Adres'] == row['Adres']]))

                                                folium.Marker(
                                                    location=[lat, lng],
                                                    popup=f"SÄ±ra: {row['SÄ±ra']}",
                                                    icon=folium.DivIcon(
                                                        icon_size=(30, 30),
                                                        icon_anchor=(15, 15),
                                                        html=icon_style.format(color="black", sira=row["SÄ±ra"])
                                                    )
                                                ).add_to(m)

                        # Nokta seÃ§imine gÃ¶re iÅŸlem yap
                        if nokta_seÃ§imi == "TÃ¼mÃ¼nÃ¼ GÃ¶ster":
                            # TÃ¼m rotalarÄ± ve noktalarÄ± gÃ¶ster
                            for i, route in enumerate(routes):
                                folium.PolyLine(
                                    locations=[(point['lat'], point['lng']) for point in route],
                                    color="green" if i < mid_point else "red",
                                    weight=5,
                                    opacity=0.7,
                                    tooltip=f"Rota ({i+1}-{i+2})"
                                ).add_to(m)

                            for index, row in filtered_df.iterrows():
                                geocode_result = gmaps.geocode(row['Adres'])
                                api_istek_sayisi += 1  # Geocoding API isteÄŸi sayÄ±sÄ±nÄ± artÄ±r
                                if geocode_result:
                                    location = geocode_result[0]['geometry']['location']
                                    lat, lng = location['lat'], location['lng']
                                    key = (round(lat, 5), round(lng, 5))
                                    if key in coords_count:
                                        lat, lng = offset_coordinates(lat, lng, coords_count[key], len(filtered_df[filtered_df['Adres'] == row['Adres']]))

                                    if row['Ä°leti Tipi'] == "Kontak AÃ§Ä±ldÄ±":
                                        lat = location['lat'] + 0.0001
                                        lng = location['lng'] + 0.0001
                                        color = "green"
                                    else:
                                        lat = location['lat'] - 0.0001
                                        lng = location['lng'] - 0.0001
                                        color = "red"
                                    popup_text = f"""
                                        <div style="width: 200px;">
                                            <b>SÄ±ra:</b> {row['SÄ±ra']}<br>
                                            <b>Plaka:</b> {row['Plaka']}<br>
                                            <b>SÃ¼rÃ¼cÃ¼:</b> {row['SÃ¼rÃ¼cÃ¼']}<br>
                                            <b>Ä°leti Tipi:</b> {row['Ä°leti Tipi']}<br>
                                            <b>Adres:</b> {row['Adres']}<br>
                                            <b>Zaman:</b> {row['Zaman']}<br>
                                        </div>
                                    """

                                    folium.Marker(
                                        location=[lat, lng],
                                        popup=popup_text,
                                        icon=folium.DivIcon(
                                            icon_size=(30, 30),
                                            icon_anchor=(15, 15),
                                            html=icon_style.format(color=color, sira=row["SÄ±ra"])
                                        )
                                    ).add_to(m)

                        elif nokta_seÃ§imi == "00.00 - 06.00 Hareketleri":
                            # 00:00 - 06:00 saatleri arasÄ±ndaki hareketleri gÃ¶ster
                            for index, row in filtered_df.iterrows():
                                geocode_result = gmaps.geocode(row['Adres'])
                                api_istek_sayisi += 1  # Geocoding API isteÄŸi sayÄ±sÄ±nÄ± artÄ±r
                                if geocode_result:
                                    location = geocode_result[0]['geometry']['location']
                                    lat, lng = location['lat'], location['lng']
                                    key = (round(lat, 5), round(lng, 5))
                                    if key in coords_count:
                                        lat, lng = offset_coordinates(lat, lng, coords_count[key], len(filtered_df[filtered_df['Adres'] == row['Adres']]))

                                    if row['Ä°leti Tipi'] == "Kontak AÃ§Ä±ldÄ±":
                                        color = "green"
                                    else:
                                        color = "red"

                                    popup_text = f"""
                                        <div style="width: 200px;">
                                            <b>SÄ±ra:</b> {row['SÄ±ra']}<br>
                                            <b>Plaka:</b> {row['Plaka']}<br>
                                            <b>SÃ¼rÃ¼cÃ¼:</b> {row['SÃ¼rÃ¼cÃ¼']}<br>
                                            <b>Ä°leti Tipi:</b> {row['Ä°leti Tipi']}<br>
                                            <b>Adres:</b> {row['Adres']}<br>
                                            <b>Zaman:</b> {row['Zaman']}<br>
                                        </div>
                                    """

                                    folium.Marker(
                                        location=[lat, lng],
                                        popup=popup_text,
                                        icon=folium.DivIcon(
                                            icon_size=(30, 30),
                                            icon_anchor=(15, 15),
                                            html=icon_style.format(color=color, sira=row["SÄ±ra"])
                                        )
                                    ).add_to(m)

                        else:
                            # SeÃ§ilen aralÄ±ktaki rotayÄ± ve noktalarÄ± gÃ¶ster
                            baÅŸlangÄ±Ã§, bitiÅŸ = map(int, nokta_seÃ§imi.split('-'))
                            aralÄ±k_df = filtered_df[(filtered_df['SÄ±ra'] >= baÅŸlangÄ±Ã§) & (filtered_df['SÄ±ra'] <= bitiÅŸ)]

                            # SeÃ§ilen aralÄ±ktaki rotalarÄ± gÃ¶ster
                            for i in range(baÅŸlangÄ±Ã§-1, bitiÅŸ-1):
                                folium.PolyLine(
                                    locations=[(point['lat'], point['lng']) for point in routes[i]],
                                    color="blue",
                                    weight=5,
                                    opacity=0.7,
                                    tooltip=f"{baÅŸlangÄ±Ã§ + i}-{baÅŸlangÄ±Ã§ + i + 1} ArasÄ±"
                                ).add_to(m)

                            # SeÃ§ilen aralÄ±ktaki noktalarÄ± gÃ¶ster
                            for index, row in aralÄ±k_df.iterrows():
                                geocode_result = gmaps.geocode(row['Adres'])
                                api_istek_sayisi += 1  # Geocoding API isteÄŸi sayÄ±sÄ±nÄ± artÄ±r
                                if geocode_result:
                                    location = geocode_result[0]['geometry']['location']
                                    if row['Ä°leti Tipi'] == "Kontak AÃ§Ä±ldÄ±":
                                        lat = location['lat'] + 0.0001
                                        lng = location['lng'] + 0.0001
                                        color = "green"
                                    else:
                                        lat = location['lat'] - 0.0001
                                        lng = location['lng'] - 0.0001
                                        color = "red"

                                    popup_text = f"""
                                        <div style="width: 200px;">
                                            <b>SÄ±ra:</b> {row['SÄ±ra']}<br>
                                            <b>Plaka:</b> {row['Plaka']}<br>
                                            <b>SÃ¼rÃ¼cÃ¼:</b> {row['SÃ¼rÃ¼cÃ¼']}<br>
                                            <b>Ä°leti Tipi:</b> {row['Ä°leti Tipi']}<br>
                                            <b>Adres:</b> {row['Adres']}<br>
                                            <b>Zaman:</b> {row['Zaman']}<br>
                                        </div>
                                    """

                                    folium.Marker(
                            location=[location['lat'], location['lng']],  # Offset kaldÄ±rÄ±ldÄ±
                            popup=popup_text,
                            icon=folium.DivIcon(
                                icon_size=(30, 30),
                                icon_anchor=(15, 15),
                                html=icon_style.format(color=color, sira=row["SÄ±ra"])
                            )
                        ).add_to(m)


                        # HaritayÄ± gÃ¶ster
                        folium_static(m, width=1500, height=600)

                        # API istek sayÄ±sÄ±nÄ± gÃ¶ster
                        st.write(f"Toplam API istek sayÄ±sÄ±: {api_istek_sayisi}")
                    else:
                        st.error("Excel dosyasÄ±nda 'Adres' sÃ¼tunu bulunamadÄ±.")
                else:
                    st.warning("LÃ¼tfen bir araÃ§ seÃ§iniz.")
            else:
                st.error("Excel dosyasÄ±nda 'Plaka' veya 'SÃ¼rÃ¼cÃ¼' sÃ¼tunu bulunamadÄ±.")
    else:
        st.warning("HenÃ¼z bir dÃ¶nÃ¼ÅŸtÃ¼rÃ¼lmÃ¼ÅŸ dosya bulunmamaktadÄ±r.")